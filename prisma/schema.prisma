// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & PLAYER
// ============================================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("player")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player Player?
}

model Player {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // Race (null until character creation)
  raceId String?
  race   Race?   @relation(fields: [raceId], references: [id])

  // Character Image (user uploaded)
  characterImage String?

  // Basic Info
  level         Int @default(1)
  currentXp     Int @default(0) // Current XP towards next level
  totalXpEarned Int @default(0) // Lifetime XP earned
  col           Int @default(0)

  // Stats (25 points at creation, +1 per level, min 0)
  str        Int @default(0)
  agi        Int @default(0)
  vit        Int @default(0)
  int        Int @default(0)
  dex        Int @default(0)
  luk        Int @default(0)
  statPoints Int @default(25)

  // Resources
  currentHp Int @default(100)
  currentAp Int @default(100)
  maxAp     Int @default(100)

  // Regen tracking
  lastHpRegen DateTime @default(now())
  lastApRegen DateTime @default(now())

  // Location
  currentLocationId String?
  currentLocation   Location? @relation(fields: [currentLocationId], references: [id])
  isInSafeZone      Boolean   @default(true)

  // Skill tracking
  learnedSkillCount Int @default(0)

  // Relations
  skills         PlayerSkill[]
  inventory      PlayerInventory[]
  combatSessions CombatSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// RACE
// ============================================

model Race {
  id          String @id @default(cuid())
  name        String @unique
  description String

  // Passive 1
  passive1Name  String
  passive1Type  String // expGain, magicAmp, npcDiscount, craftingSuccess, physicalDamage, evasion, dropRate, critDamage
  passive1Value Float // 5 = 5%

  // Passive 2
  passive2Name  String
  passive2Type  String // cookingSuccess, accuracy, alchemySuccess, weightCapacity, maxHp, critChance, debuffResist, cdr
  passive2Value Float // 3 = 3%

  players Player[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// WEAPON CATEGORY & WEAPONS
// ============================================

model WeaponCategory {
  id          String @id @default(cuid())
  name        String @unique
  description String

  primaryStat   String // STR, DEX, INT
  secondaryStat String? // Optional secondary stat

  isRanged    Boolean @default(false)
  isTwoHanded Boolean @default(false)
  isMagic     Boolean @default(false)

  weapons Weapon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Weapon {
  id          String @id @default(cuid())
  name        String
  description String

  categoryId String
  category   WeaponCategory @relation(fields: [categoryId], references: [id])

  rarity String @default("Common") // Common, Uncommon, Rare, Epic, Legendary

  // Combat Stats
  baseDamage  Int
  attackSpeed Float @default(1.0)
  critBonus   Float @default(0)
  range       Int   @default(1)

  // Requirements
  levelRequired Int @default(1)
  strRequired   Int @default(0)
  agiRequired   Int @default(0)
  vitRequired   Int @default(0)
  intRequired   Int @default(0)
  dexRequired   Int @default(0)
  lukRequired   Int @default(0)

  // Physical
  weight        Int
  maxDurability Int @default(100)

  // Economy
  buyPrice  Int @default(0)
  sellPrice Int @default(0)

  // Flags
  isBasic     Boolean @default(false)
  isTradeable Boolean @default(true)

  inventory PlayerInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// SKILLS
// ============================================

model Skill {
  id                   String  @id @default(cuid())
  name                 String
  description          String // Effect description (what it does mechanically)
  executionDescription String? // Narrative description of how the skill is performed (for game events)

  // Skill Icon
  iconUrl String? // URL to skill icon image

  // Type
  skillType  String // Attack, Defensive, Buff, Debuff, Movement, Utility, Support
  damageType String @default("physical") // physical, magic, none

  // Weapon Requirement (for starter skills)
  weaponRequirement String @default("any") // melee_only, ranged_only, magic_only, any

  // Magic Utility Mode (for magic skills used with non-magic weapons)
  hasUtilityMode  Boolean @default(false)
  utilityEffect   String? // fire_enchant, ice_enchant, lightning_enchant, shadow_enchant, holy_enchant
  utilityDuration Int? // turns or attacks the enchant lasts

  // Skill Tree Structure
  starterSkillName String // Root skill name for tree tracking
  parentId         String? // Parent skill ID in the tree
  parent           Skill?  @relation("SkillTree", fields: [parentId], references: [id])
  children         Skill[] @relation("SkillTree")
  stage            Int     @default(0) // 0-5

  // Variant Type
  // root, upgrade, original_variant, buff_variant, debuff_variant, unique, aoe_variant, combo_variant, counter_variant, mobility_variant, sustain_variant
  variantType String @default("base")

  // Combat Stats (Amp-based system)
  ampPercent Int @default(100) // 50-200% multiplier on weapon base
  apCost     Int @default(5) // 3-10 AP
  cooldown   Int @default(1) // 1-5 turns
  speed      Int @default(50) // 0-100, higher = faster action priority

  // Targeting
  targetType String @default("single") // single, self, aoe_cone, aoe_circle, aoe_line, all_enemies
  range      Int    @default(1) // 1 = melee, 2+ = ranged
  hitCount   Int    @default(1) // 1-4 hits for combo skills

  // Buff Effects (for buff_variant)
  buffType     String? // empower, focus, precision, berserk, fortify, barrier, evasion, reflect, haste, regen, stealth, immunity
  buffValue    Int? // Strength of buff (%, flat value, etc.)
  buffDuration Int? // turns

  // Debuff Effects (for debuff_variant)
  debuffType     String? // bleed, burn, poison, weaken, armor_break, slow, blind, stun, root, silence, taunt, marked, curse
  debuffValue    Int? // Strength of debuff (damage, %, etc.)
  debuffDuration Int? // turns
  debuffChance   Int?    @default(100) // % chance to apply

  // Special Effects
  lifestealPercent Int? // for sustain variant
  armorPierce      Int? // % of armor ignored
  bonusVsGuard     Int? // extra damage % vs guarding
  bonusVsDebuffed  Int? // extra damage % vs debuffed enemies

  // Counter/Reactive
  isCounter        Boolean @default(false)
  isReaction       Boolean @default(false) // Dodge, Guard, Counter - triggers against enemy attacks
  triggerCondition String? // after_dodge, after_parry, on_hit_taken

  // Passive (unlocked at each stage)
  passive String? // e.g., "Quick Slash attacks are 5% faster"

  // Narrative Templates (for combat storytelling)
  narrativeSuccess String? // "Your blade connects with a satisfying impact!"
  narrativeCrit    String? // "A devastating blow! Critical hit!"
  narrativeMiss    String? // "Your swing goes wide, hitting nothing but air."
  narrativeBlocked String? // "The enemy raises their guard, deflecting your attack."

  // State for admin builder
  isSaved  Boolean @default(false)
  isLocked Boolean @default(false)

  // Relations
  playerSkills PlayerSkill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([starterSkillName])
  @@index([stage])
}

// ============================================
// PLAYER SKILLS & SKILL BAR
// ============================================

model PlayerSkill {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  skillId String
  skill   Skill  @relation(fields: [skillId], references: [id])

  useCount     Int     @default(0) // Times used (for evolution tracking)
  isEquipped   Boolean @default(false)
  slotPosition Int? // 1-20 skill bar slot

  learnedAt DateTime @default(now())

  @@unique([playerId, skillId])
}

// ============================================
// PLAYER INVENTORY
// ============================================

model PlayerInventory {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  weaponId String
  weapon   Weapon @relation(fields: [weaponId], references: [id])

  currentDurability Int
  isEquipped        Boolean @default(false)
  equipSlot         String? // mainHand, offHand

  acquiredAt DateTime @default(now())
}

// ============================================
// MONSTERS & COMBAT
// ============================================

model Monster {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  imageUrl    String?

  // Stats (no location/level - those are assigned when attaching to areas)
  maxHp        Int
  attack       Int // Base physical damage
  magicAttack  Int @default(0) // Base magic damage
  defense      Int // Damage reduction
  magicDefense Int @default(0)
  accuracy     Int @default(70) // Hit chance modifier
  evasion      Int @default(10) // Dodge chance modifier

  // Rewards
  xpReward    Int
  colReward   Int

  // Relations
  skills         MonsterSkillAssignment[]
  lootDrops      MonsterLootDrop[]
  combatSessions CombatSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Standalone Monster Skill Database (reusable across monsters)
model MonsterSkill {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String  @default("ðŸ‘Š") // Emoji icon

  // Skill Category
  category String @default("melee") // melee, ranged, aoe, self, reactive, signature

  // Combat Stats
  damageType String @default("physical") // physical, magic, true
  baseDamage Int    @default(0)
  hitCount   Int    @default(1) // Number of hits
  accuracy   Int    @default(100) // Hit chance %
  speed      Int    @default(50) // Action priority (0-100)

  // Scaling (optional)
  scalesWithAttack Boolean @default(true)
  scalingPercent   Int     @default(100) // % of monster's attack stat

  // Effects
  appliesDebuff  String? // bleed, poison, stun, burn, freeze, etc.
  debuffChance   Int     @default(100)
  debuffDuration Int     @default(2)
  debuffValue    Int     @default(0)

  appliesBuff   String? // enrage, shield, regen, etc.
  buffDuration  Int     @default(2)
  buffValue     Int     @default(0)

  // Self effects
  selfHeal    Int @default(0) // HP restored to monster
  selfDamage  Int @default(0) // HP cost to use

  // Narrative Templates
  narrativeUse  String @default("The monster attacks!") // Action description
  narrativeHit  String @default("The attack connects!") // On hit
  narrativeMiss String @default("The attack misses!") // On miss
  narrativeCrit String @default("Critical hit!") // On crit

  // Relations
  assignments MonsterSkillAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Junction table: Attach skills to monsters
model MonsterSkillAssignment {
  id             String       @id @default(cuid())
  monsterId      String
  monster        Monster      @relation(fields: [monsterId], references: [id], onDelete: Cascade)
  monsterSkillId String
  monsterSkill   MonsterSkill @relation(fields: [monsterSkillId], references: [id], onDelete: Cascade)

  // Override base skill values for this specific monster (optional)
  damageOverride   Int?
  accuracyOverride Int?
  speedOverride    Int?

  // Priority in attack patterns (lower = used more often)
  priority Int @default(1)

  createdAt DateTime @default(now())

  @@unique([monsterId, monsterSkillId])
  @@index([monsterId])
  @@index([monsterSkillId])
}

// Junction table: Attach items to monsters as loot
model MonsterLootDrop {
  id        String  @id @default(cuid())
  monsterId String
  monster   Monster @relation(fields: [monsterId], references: [id], onDelete: Cascade)
  itemId    String
  item      Item    @relation(fields: [itemId], references: [id], onDelete: Cascade)

  dropChance  Float // 0.0 - 1.0 (0.1 = 10%)
  minQuantity Int   @default(1)
  maxQuantity Int   @default(1)

  createdAt DateTime @default(now())

  @@unique([monsterId, itemId])
  @@index([monsterId])
  @@index([itemId])
}

// ============================================
// ITEMS DATABASE
// ============================================

model Item {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String  @default("ðŸ“¦") // Emoji icon

  // Item Type
  itemType String // consumable, material, equipment, key_item

  // For consumables
  useEffect   String? // heal, restore_ap, buff, cure
  effectValue Int     @default(0)

  // For equipment (future)
  equipSlot    String? // weapon, armor, accessory
  statBonuses  Json    @default("{}") // {"str": 5, "vit": 3}

  // Economy
  buyPrice  Int @default(0) // Price to buy from shop (0 = not buyable)
  sellPrice Int @default(0) // Price when selling

  // Stacking
  maxStack Int     @default(99)
  isUnique Boolean @default(false) // Only 1 can exist in inventory

  // Rarity
  rarity String @default("common") // common, uncommon, rare, epic, legendary

  // Relations
  lootDrops MonsterLootDrop[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CombatSession {
  id        String  @id @default(cuid())
  playerId  String
  player    Player  @relation(fields: [playerId], references: [id])
  monsterId String
  monster   Monster @relation(fields: [monsterId], references: [id])

  // Combat State
  playerHp  Int
  playerAp  Int
  monsterHp Int
  turn      Int    @default(1)
  status    String @default("active") // active, won, lost, fled

  // Queued Actions (JSON arrays)
  playerQueue Json @default("[]") // [{type: "skill"|"item", id: string}]
  enemyQueue  Json @default("[]") // Generated from monster AI

  // Active Effects (JSON arrays)
  playerBuffs    Json @default("[]") // [{type, value, duration}]
  playerDebuffs  Json @default("[]")
  monsterBuffs   Json @default("[]")
  monsterDebuffs Json @default("[]")

  // Cooldowns (JSON map)
  skillCooldowns Json @default("{}") // {skillId: turnsRemaining}

  // Timestamps
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Relations
  logs CombatLog[]

  @@index([playerId])
  @@index([status])
}

model CombatLog {
  id        String        @id @default(cuid())
  sessionId String
  session   CombatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  turn          Int
  sequenceOrder Int // Order within the turn (1, 2, 3...)

  // Actor
  actor      String // "player" or "monster"
  actionType String // "skill", "item", "reaction"
  actionId   String? // Skill or Item ID
  actionName String

  // Target
  target String // "player" or "monster"

  // Roll Results
  hitRoll   Int? // What was rolled (1-100)
  hitNeeded Int? // What was needed to hit
  didHit    Boolean @default(true)

  critRoll   Int?
  critNeeded Int?
  didCrit    Boolean @default(false)

  // Effects
  damageDealt   Int?
  healingDone   Int?
  buffApplied   String?
  debuffApplied String?

  // Narrative
  narration String // The story text for this action

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([turn])
}

// ============================================
// LOCATIONS
// ============================================

model Location {
  id          String  @id @default(cuid())
  name        String
  description String
  floor       Int     @default(1)
  isSafeZone  Boolean @default(false)

  players Player[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
