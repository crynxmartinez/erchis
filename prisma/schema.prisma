// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & PLAYER
// ============================================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("player")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player    Player?
}

model Player {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])

  // Race (null until character creation)
  raceId    String?
  race      Race?    @relation(fields: [raceId], references: [id])

  // Character Image (user uploaded)
  characterImage String?

  // Basic Info
  level     Int      @default(1)
  exp       Int      @default(0)
  col       Int      @default(0)

  // Stats (25 points at creation, +1 per level, min 0)
  str       Int      @default(0)
  agi       Int      @default(0)
  vit       Int      @default(0)
  int       Int      @default(0)
  dex       Int      @default(0)
  luk       Int      @default(0)
  statPoints Int     @default(25)

  // Resources
  currentHp Int      @default(100)
  currentAp Int      @default(100)
  maxAp     Int      @default(100)

  // Regen tracking
  lastHpRegen DateTime @default(now())
  lastApRegen DateTime @default(now())

  // Location
  currentLocationId String?
  currentLocation   Location? @relation(fields: [currentLocationId], references: [id])
  isInSafeZone      Boolean   @default(true)

  // Skill tracking
  learnedSkillCount Int @default(0)

  // Relations
  skills        PlayerSkill[]
  inventory     PlayerInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// RACE
// ============================================

model Race {
  id          String   @id @default(cuid())
  name        String   @unique
  description String

  // Passive 1
  passive1Name  String
  passive1Type  String   // expGain, magicAmp, npcDiscount, craftingSuccess, physicalDamage, evasion, dropRate, critDamage
  passive1Value Float    // 5 = 5%

  // Passive 2
  passive2Name  String
  passive2Type  String   // cookingSuccess, accuracy, alchemySuccess, weightCapacity, maxHp, critChance, debuffResist, cdr
  passive2Value Float    // 3 = 3%

  players Player[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// WEAPON CATEGORY & WEAPONS
// ============================================

model WeaponCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String

  primaryStat   String   // STR, DEX, INT
  secondaryStat String?  // Optional secondary stat

  isRanged    Boolean @default(false)
  isTwoHanded Boolean @default(false)
  isMagic     Boolean @default(false)

  weapons Weapon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Weapon {
  id          String   @id @default(cuid())
  name        String
  description String

  categoryId String
  category   WeaponCategory @relation(fields: [categoryId], references: [id])

  rarity String @default("Common") // Common, Uncommon, Rare, Epic, Legendary

  // Combat Stats
  baseDamage   Int
  attackSpeed  Float   @default(1.0)
  critBonus    Float   @default(0)
  range        Int     @default(1)

  // Requirements
  levelRequired Int @default(1)
  strRequired   Int @default(0)
  agiRequired   Int @default(0)
  vitRequired   Int @default(0)
  intRequired   Int @default(0)
  dexRequired   Int @default(0)
  lukRequired   Int @default(0)

  // Physical
  weight        Int
  maxDurability Int @default(100)

  // Economy
  buyPrice  Int @default(0)
  sellPrice Int @default(0)

  // Flags
  isBasic     Boolean @default(false)
  isTradeable Boolean @default(true)

  inventory PlayerInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// SKILLS
// ============================================

model Skill {
  id          String   @id @default(cuid())
  name        String
  description String   // Effect description (what it does mechanically)
  executionDescription String? // Narrative description of how the skill is performed (for game events)

  // Type
  skillType   String   // Attack, Defensive, Buff, Debuff, Movement, Utility, Support
  damageType  String   @default("physical") // physical, magic, none
  
  // Weapon Requirement (for starter skills)
  weaponRequirement String @default("any") // melee_only, ranged_only, magic_only, any
  
  // Magic Utility Mode (for magic skills used with non-magic weapons)
  hasUtilityMode    Boolean @default(false)
  utilityEffect     String?  // fire_enchant, ice_enchant, lightning_enchant, shadow_enchant, holy_enchant
  utilityDuration   Int?     // turns or attacks the enchant lasts

  // Skill Tree Structure
  starterSkillName String   // Root skill name for tree tracking
  parentId         String?  // Parent skill ID in the tree
  parent           Skill?   @relation("SkillTree", fields: [parentId], references: [id])
  children         Skill[]  @relation("SkillTree")
  stage            Int      @default(0)  // 0-5
  
  // Variant Type
  // root, upgrade, original_variant, buff_variant, debuff_variant, unique, aoe_variant, combo_variant, counter_variant, mobility_variant, sustain_variant
  variantType      String   @default("root")
  
  // Combat Stats (Amp-based system)
  ampPercent    Int      @default(100) // 50-200% multiplier on weapon base
  apCost        Int      @default(5)   // 3-10 AP
  cooldown      Int      @default(1)   // 1-5 turns
  
  // Targeting
  targetType    String   @default("single") // single, self, aoe_cone, aoe_circle, aoe_line, all_enemies
  range         Int      @default(1)   // 1 = melee, 2+ = ranged
  hitCount      Int      @default(1)   // 1-4 hits for combo skills
  
  // Buff Effects (for buff_variant)
  buffType         String?  // haste, empower, fortify, focus, regen
  buffDuration     Int?     // turns
  
  // Debuff Effects (for debuff_variant)
  debuffType       String?  // slow, bleed, armor_break, weaken, blind, stun
  debuffDuration   Int?     // turns
  debuffChance     Int?     @default(100) // % chance to apply
  
  // Special Effects
  lifestealPercent Int?     // for sustain variant
  armorPierce      Int?     // % of armor ignored
  bonusVsGuard     Int?     // extra damage % vs guarding
  bonusVsDebuffed  Int?     // extra damage % vs debuffed enemies
  
  // Counter/Reactive
  isCounter        Boolean  @default(false)
  triggerCondition String?  // after_dodge, after_parry, on_hit_taken
  
  // Passive (unlocked at each stage)
  passive       String?  // e.g., "Quick Slash attacks are 5% faster"
  
  // State for admin builder
  isSaved       Boolean  @default(false)

  // Relations
  playerSkills PlayerSkill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([starterSkillName])
  @@index([stage])
}

// ============================================
// PLAYER SKILLS & SKILL BAR
// ============================================

model PlayerSkill {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  skillId String
  skill   Skill  @relation(fields: [skillId], references: [id])

  useCount    Int      @default(0)  // Times used (for evolution tracking)
  isEquipped  Boolean  @default(false)
  slotPosition Int?    // 1-20 skill bar slot

  learnedAt DateTime @default(now())

  @@unique([playerId, skillId])
}

// ============================================
// PLAYER INVENTORY
// ============================================

model PlayerInventory {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  weaponId String
  weapon   Weapon @relation(fields: [weaponId], references: [id])

  currentDurability Int
  isEquipped        Boolean @default(false)
  equipSlot         String? // mainHand, offHand

  acquiredAt DateTime @default(now())
}

// ============================================
// LOCATIONS
// ============================================

model Location {
  id          String  @id @default(cuid())
  name        String
  description String
  floor       Int     @default(1)
  isSafeZone  Boolean @default(false)

  players Player[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
