// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & PLAYER
// ============================================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  role      String   @default("player")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  player    Player?
}

model Player {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])

  // Race (null until character creation)
  raceId    String?
  race      Race?    @relation(fields: [raceId], references: [id])

  // Character Image (user uploaded)
  characterImage String?

  // Basic Info
  level     Int      @default(1)
  exp       Int      @default(0)
  col       Int      @default(0)

  // Stats (25 points at creation, +1 per level, min 0)
  str       Int      @default(0)
  agi       Int      @default(0)
  vit       Int      @default(0)
  int       Int      @default(0)
  dex       Int      @default(0)
  luk       Int      @default(0)
  statPoints Int     @default(25)

  // Resources
  currentHp Int      @default(100)
  currentAp Int      @default(100)
  maxAp     Int      @default(100)

  // Regen tracking
  lastHpRegen DateTime @default(now())
  lastApRegen DateTime @default(now())

  // Location
  currentLocationId String?
  currentLocation   Location? @relation(fields: [currentLocationId], references: [id])
  isInSafeZone      Boolean   @default(true)

  // Skill tracking
  learnedSkillCount Int @default(0)

  // Relations
  skills        PlayerSkill[]
  skillBar      PlayerSkillBar[]
  inventory     PlayerInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// RACE
// ============================================

model Race {
  id          String   @id @default(cuid())
  name        String   @unique
  description String

  // Passive 1
  passive1Name  String
  passive1Type  String   // expGain, magicAmp, npcDiscount, craftingSuccess, physicalDamage, evasion, dropRate, critDamage
  passive1Value Float    // 5 = 5%

  // Passive 2
  passive2Name  String
  passive2Type  String   // cookingSuccess, accuracy, alchemySuccess, weightCapacity, maxHp, critChance, debuffResist, cdr
  passive2Value Float    // 3 = 3%

  players Player[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// WEAPON CATEGORY & WEAPONS
// ============================================

model WeaponCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String

  primaryStat   String   // STR, DEX, INT
  secondaryStat String?  // Optional secondary stat

  isRanged    Boolean @default(false)
  isTwoHanded Boolean @default(false)
  isMagic     Boolean @default(false)

  weapons Weapon[]
  skills  Skill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Weapon {
  id          String   @id @default(cuid())
  name        String
  description String

  categoryId String
  category   WeaponCategory @relation(fields: [categoryId], references: [id])

  rarity String @default("Common") // Common, Uncommon, Rare, Epic, Legendary

  // Combat Stats
  baseDamage   Int
  attackSpeed  Float   @default(1.0)
  critBonus    Float   @default(0)
  range        Int     @default(1)

  // Requirements
  levelRequired Int @default(1)
  strRequired   Int @default(0)
  agiRequired   Int @default(0)
  vitRequired   Int @default(0)
  intRequired   Int @default(0)
  dexRequired   Int @default(0)
  lukRequired   Int @default(0)

  // Physical
  weight        Int
  maxDurability Int @default(100)

  // Economy
  buyPrice  Int @default(0)
  sellPrice Int @default(0)

  // Flags
  isBasic     Boolean @default(false)
  isTradeable Boolean @default(true)

  inventory PlayerInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// SKILLS
// ============================================

model Skill {
  id          String   @id @default(cuid())
  name        String
  description String   // Effect description

  // Category (null = universal skill)
  categoryId String?
  category   WeaponCategory? @relation(fields: [categoryId], references: [id])

  // Skill Tree Structure
  starterSkillName String?  // e.g., "Quick Slash" - the root skill this belongs to
  parentId         String?  // Parent skill ID in the tree
  parent           Skill?   @relation("SkillTree", fields: [parentId], references: [id])
  children         Skill[]  @relation("SkillTree")
  
  stage            Int      @default(0)  // 0-5
  archetype        String   @default("root") // root, power, speed, utility, mobility
  
  // Variant Type (for skill generation)
  // upgrade, original_variant, buff_variant, debuff_variant, unique, aoe_variant, combo_variant, counter_variant, mobility_variant, sustain_variant
  variantType      String   @default("root")
  
  // Buff/Debuff info (for buff_variant, debuff_variant, sustain_variant)
  buffType         String?  // haste, empower, fortify, focus, regen
  buffDuration     Int?     // turns
  debuffType       String?  // slow, bleed, armor_break, weaken, blind
  debuffDuration   Int?     // turns
  lifestealPercent Int?     // for sustain variant
  hitCount         Int?     // for combo variant (2-4)
  
  // State for admin builder
  isSaved          Boolean  @default(false) // false until admin clicks Save

  skillType String // Attack, Attack / Combo, Attack / Movement, etc.

  // Combat Stats
  damage        String   @default("100%") // e.g., "100% weapon damage", "50% x3 hits"
  apCost        Int      @default(5)
  cooldown      Int      @default(1) // Turns (minimum 1, round up)

  // Passive (unlocked at each stage)
  passive       String?  // e.g., "Quick Slash attacks are 5% faster"

  // Legacy fields for compatibility
  baseDamage    Int   @default(0)
  damageScaling Float @default(0)
  scalingStat   String? // STR, DEX, INT
  cooldownFloat Float @default(0)

  // Range & Area
  range     Int     @default(1)
  isAoE     Boolean @default(false)
  aoeRadius Float   @default(0)

  // Special Effects
  effectType     String? // stun, slow, bleed, poison, burn, knockback
  effectChance   Float   @default(0)
  effectDuration Float   @default(0)
  effectValue    Float   @default(0)

  // Requirements
  levelRequired       Int     @default(1)
  usesRequired        Int     @default(0) // Uses needed to unlock (100, 300, 500, 900, 1500)

  // Flags
  isBasic   Boolean @default(true)  // Starter skill (free from trainer)
  isPassive Boolean @default(false)
  isUniversal Boolean @default(false) // No weapon required

  playerSkills PlayerSkill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([starterSkillName])
  @@index([categoryId])
  @@index([stage])
}

// ============================================
// PLAYER SKILLS & SKILL BAR
// ============================================

model PlayerSkill {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  skillId String
  skill   Skill  @relation(fields: [skillId], references: [id])

  useCount Int @default(0)
  level    Int @default(1)

  learnedAt DateTime @default(now())

  skillBar PlayerSkillBar[]

  @@unique([playerId, skillId])
}

model PlayerSkillBar {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  slotPosition  Int
  playerSkillId String
  playerSkill   PlayerSkill @relation(fields: [playerSkillId], references: [id])

  @@unique([playerId, slotPosition])
}

// ============================================
// PLAYER INVENTORY
// ============================================

model PlayerInventory {
  id       String @id @default(cuid())
  playerId String
  player   Player @relation(fields: [playerId], references: [id])

  weaponId String
  weapon   Weapon @relation(fields: [weaponId], references: [id])

  currentDurability Int
  isEquipped        Boolean @default(false)
  equipSlot         String? // mainHand, offHand

  acquiredAt DateTime @default(now())
}

// ============================================
// LOCATIONS
// ============================================

model Location {
  id          String  @id @default(cuid())
  name        String
  description String
  floor       Int     @default(1)
  isSafeZone  Boolean @default(false)

  players Player[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
